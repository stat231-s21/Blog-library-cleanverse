library(tidyverse)
library(dplyr)
library(readxl)

# create TN plot: proportion of race vaccinated over time
tn_vax <- read_excel("/Users/smolea/git/Blog-library-cleanverse/amaya/TN.covid.demographics.state.XLSX") %>%
  filter(CATEGORY == "RACE") %>%
  mutate(date = as.Date(DATE),
         race = CAT_DETAIL,
         count = VACCINE_COUNT
         ) %>%
  select(date, race, count) %>%
  # divide by calculated population by race in TN, 2021
  # set unknown counts to 0, potentially leave out
  mutate(frac = case_when(race == "ASIAN" ~ count/121524.55,
                          race == "BLACK OR AFRICAN AMERICAN" ~ count/1163857.976,
                          race == "OTHER/MULTIRACIAL" ~ count/271520.566,
                          race == "WHITE" ~ count/5387356.908,
                          race == "UNKNOWN" ~ 0,
                          TRUE ~ count))
tn <- ggplot(tn_vax, aes(x = date, y = frac, colour = race)) +
  geom_line()
tn


# create CA plot: proportion of race vaccinated over time
ca_vax <- read_csv("/Users/smolea/git/Blog-library-cleanverse/amaya/vaccine_demographics_ca.csv") %>%
  filter(demographic_category == "Race/Ethnicity") %>%
  mutate(race0 = demographic_value,
         date = administered_date,
         count = cumulative_fully_vaccinated) %>%
  select(race0, date, count) %>%
  mutate(race = case_when(race0 == "Other Race" ~ "Other/Multiracial",
                            race0 == "Multiracial" ~ "Other/Multiracial",
                            TRUE ~ race0)) %>%
  group_by(race, date) %>%
  summarise(race = race,
            count = sum(count),
            date = date) %>%
  # divide by calculated population by race in CA, 2021
  # set unknown counts to 0, potentially leave out
  mutate(frac = case_when(race == "American Indian or Alaska Native" ~ count/138647.25,
                          race == "Other/Multiracial" ~ count/1319129.55,
                          race == "Black or African American" ~ count/2182703.85,
                          race == "White" ~ count/14514386.4,
                          race == "Latino" ~ count/15564144.15,
                          race == "Native Hawaiian or Other Pacific Islander" ~ count/142608.6,
                          race == "Asian" ~ count/5751880.2,
                          race == "Unknown" ~ 0,
                          TRUE ~ count))
ca <- ggplot(ca_vax, aes(x = date, y = frac, colour = race)) +
  geom_line()
ca


# create data for comparison maps
ca_county <- read_csv("/Users/smolea/git/Blog-library-cleanverse/amaya/CA_countydemo.csv") 
ca_county <- ca_county %>%
  filter(demographic_category == "Race/Ethnicity" & (administered_date == as.Date("2021-04-15") | administered_date == as.Date("2021-02-15"))) %>%
  select(county, demographic_value, est_population, cumulative_fully_vaccinated, administered_date) %>%
  mutate(new = case_when(demographic_value == "American Indian or Alaska Native" ~ "Non-White",
                         demographic_value == "Multiracial" ~ "Non-White",
                         demographic_value == "Other" ~ "Non-White",
                         demographic_value == "Black or African American" ~ "Non-White",
                         demographic_value == "Latino" ~ "Non-White",
                         demographic_value == "Native Hawaiian or Other Pacific Islander" ~ "Non-White",
                         demographic_value == "Asian" ~ "Non-White",
                         demographic_value == "Unknown" ~ "Non-White",
                         TRUE ~ "White"))
ca_county
tn_county <- read_excel("/Users/smolea/git/Blog-library-cleanverse/amaya/TN_County_Vax_Demographics.XLSX") %>%
  mutate(date = as.Date(DATE)) %>%
  filter(CATEGORY == "RACE" & (date == as.Date("2021-02-15") | date == as.Date("2021-04-15"))) %>%
  select(COUNTY, CAT_DETAIL, RECIPIENT_COUNT, date) %>%
  mutate(new = case_when(CAT_DETAIL == "UNKNOWN" ~ "Unknown",
                         CAT_DETAIL == "ASIAN" ~ "Non-White",
                         CAT_DETAIL == "OTHER/MULTIRACIAL" ~ "Non-White",
                         CAT_DETAIL == "BLACK OR AFRICAN AMERICAN" ~ "Non-White",
                         TRUE ~ "White"))
tn_county
  


  
  
