---
title: "KV Blog Wrangling"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

library(tidyverse)
library(viridis)
# for networks
library(ggnetwork)
library(igraph)
# for mapping
library(datasets)
library(mdsr)
library(gapminder)
library(fivethirtyeight)
library(maps)
library(ggplot2)
library(gganimate)
library(gifski)

knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
kv_vaccine_states <- read_csv("us-total-covid-19-vaccine-doses-administered_final.csv")

states <- c("Alabama",
"Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida",
"Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana",
"Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri",
"Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York State", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island",
"South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia",
"Washington", "West Virginia", "Wisconsin", "Wyoming")

kv_states <- kv_vaccine_states %>%
  filter(Entity %in% states) %>%
  mutate(state = tolower(Entity)
         , Day = as.Date(Day, format="%m/%d/%y")) %>%
  select(Day, state, daily_vaccinations, state_population) %>%
  group_by(state) %>%
  summarise(Day, state_population, cumulative_vaccinations = cumsum(daily_vaccinations)) %>%
  mutate(percentpop = cumulative_vaccinations/state_population)
  
            # percent_vac = cumulative_vaccinations / kv_vaccine_states$state_population)


  #filter(Day == "2021-01-13" | Day == "2021-01-14") #%>%

  #mutate(test = ifelse(Day=="2021-02-14", 14, 15))
  #group_by(Day, Entitylower)
         
# without filtering, days include 1/13/21 to 4/26/21
#min(kv_states$Day)
#max(kv_states$Day)
#mosaic::favstats(~daily_vaccinations, data = kv_states)
#unique(kv_states$Day)
#mosaic::favstats(Day ~ state, data=kv_states)
```

## Making Map

```{r}
usa_states <- map_data(map = "state", region = ".") 


# changing from left_join to inner_join to remove alaska & hawaii
usa_vaccine_states <- kv_states %>%
  inner_join(usa_states, by = c("state" = "region"))
  

# IT'S WORKING!! after removed Alaska and Hawaii 
anim_map_us <- usa_vaccine_states %>%
ggplot() +
 geom_polygon(aes(x = long, y = lat, group = group, fill = cumulative_vaccinations)
            ,color = "white") +
 theme_void() +
 coord_fixed(ratio = 1.3) +
 labs(fill = "Number of People Vaccinated"
      , title = "USA Daily Vaccinations by State"
      , subtitle = "{closest_state}") +
      #,  subtitle="{format(frame_time, '%m/%d/%y')}"
    
  theme(legend.position="right") +
  scale_fill_distiller(palette = "YlGnBu", direction = "horizantle")+#, limits = c(0,30000000)) +
 #transition_time(time = Day)
 transition_states(state = Day, transition_length=2
                  , state_length = 5)
anim_map_us
# number of days: 127
#length(unique(kv_vaccine_states$Day))
# why is this different? days: 104
#length(unique(usa_vaccine_states$Day))
#https://stackoverflow.com/questions/52332967/problem-with-many-50-states-in-gganimate
animate(anim_map_us, nframes = 2*length(unique(usa_vaccine_states$Day))
        , renderer = gifski_renderer("kriti/usa_vaccine_number_all_total_states.gif"))

#anim_save() 

 
```

```{r}
###### comparing feb 14 vs feb 15
# feb14 <- usa_vaccine_states %>%
#   filter(Day == "2021-02-14")
# 
# feb15 <- usa_vaccine_states %>%
#   filter(Day == "2021-02-15")
# 
# anti_join(feb14,feb15,by=c("long","lat","group"))
# anti_join(feb15,feb14,by=c("long","lat","group"))


# feb 14, 2021 - works
# ggplot(filter(usa_vaccine_states, Day=="2021-01-13")
#        , aes(x = long, y = lat, group = group
#                       , fill = daily_vaccinations)) +
#   geom_polygon(color = "white") +
#   theme_void() +
#   coord_fixed(ratio = 1.3) +
#   labs(fill = "Number of People Vaccinated"
#        , title = "USA Daily Vaccinations by State"
#        , caption = "Kriti Verma") +
#   theme(legend.position="right") +
#   scale_fill_distiller(palette = "YlGnBu", direction = "horizantle"
#                        , limits = c(2000,500000))
# 
# # feb 15, 2021 - works
# ggplot(filter(usa_vaccine_states, Day=="2021-01-14")
#        , aes(x = long, y = lat, group = group
#                       , fill = daily_vaccinations)) +
#   geom_polygon(color = "white") +
#   theme_void() +
#   coord_fixed(ratio = 1.3) +
#   labs(fill = "Number of People Vaccinated"
#        , title = "USA Daily Vaccinations by State" 
#        , caption = "Kriti Verma") +
#   theme(legend.position="right") +
#   scale_fill_distiller(palette = "YlGnBu", direction = "horizantle"
#                        , limits = c(2000,500000))
# 
# # facetted by day - works
# ggplot(usa_vaccine_states
#        , aes(x = long, y = lat, group = group
#                       , fill = daily_vaccinations)) +
#   geom_polygon(color = "white") +
#   theme_void() +
#   coord_fixed(ratio = 1.3) +
#   labs(fill = "Number of People Vaccinated"
#        , title = "USA Daily Vaccinations by State" 
#        , caption = "Kriti Verma") +
#   theme(legend.position="right") +
#   scale_fill_distiller(palette = "YlGnBu", direction = "horizantle"
#                        , limits = c(2000,500000)) +
#   facet_grid(~Day)

# animated with geom_point instead of geom_polygon
# works (as in, no error returned & text rotates between the two days)
# but why 15 so quick when use transition_time / only stays for short time?
# ggplot(usa_vaccine_states) +
#  geom_point(aes(x = long, y = lat, group = group
#                   , fill = daily_vaccinations)
#               ,color = "white") +
#  theme_void() +
#  coord_fixed(ratio = 1.3) +
#  labs(fill = "Number of People Vaccinated"
#       , title = "USA Daily Vaccinations by State"
#       , caption = "Kriti Verma") +
#   theme(legend.position="right") +
#   scale_fill_distiller(palette = "YlGnBu", direction = "horizantle") +
#   geom_text(aes(y=45, x=-100, label=Day)) +
#   #transition_time(time = Day)
#   transition_states(state = Day, transition_length=2
#                       , state_length = 5
#                       , wrap = TRUE)

# animated with geom_point instead of geom_polygon
# remove 'color=white' so can see state outlines
# works (as in, no error returned & rotates between the days)
# ggplot(usa_vaccine_states) +
#  geom_point(aes(x = long, y = lat, group = group
#                   , fill = daily_vaccinations)) +
#               #,color = "white") +
#  theme_void() +
#  coord_fixed(ratio = 1.3) +
#  labs(fill = "Number of People Vaccinated"
#       , title = "USA Daily Vaccinations by State"
#       , caption = "Kriti Verma") +
#   theme(legend.position="right") +
#   scale_fill_distiller(palette = "YlGnBu", direction = "horizantle"
#                        , limits = c(2000,200000)) +
#   geom_text(aes(y=45, x=-100, label=Day)) +
#   #transition_time(time = Day)
#   transition_states(state = Day, transition_length=2
#                       , state_length = 5
#                       , wrap = TRUE)

 #transition_states(Day, transition_length = 10, state_length = 1)
  #gganimate(animatevar)
  #transition_time(Day, range = c("2-14-2021", "3-4-2021"))
  # transition_states(Day, state_length = 1)
  #transition_time(Day) 
  #transition_states(Day, 3, 20)
  #transition_states(Day, transition_length = 10, state_length = 1)
  #transition_time(Day, transition_length = 10, time_length = 1)
  
```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
